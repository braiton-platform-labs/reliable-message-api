apiVersion: v1
kind: ConfigMap
metadata:
  name: kong-poststart
  labels:
    app: kong

data:
  poststart-bootstrap.sh: |
    #!/usr/bin/env sh
    # Best-effort bootstrap for local dev.
    # This must never block or crash Kong startup; if bootstrap can't complete yet, exit 0.
    set -u

    max_wait_seconds="${KONG_BOOTSTRAP_WAIT_SECONDS:-120}"
    start="$(date +%s)"

    while :; do
      now="$(date +%s)"
      elapsed="$((now - start))"
      if [ "$elapsed" -ge "$max_wait_seconds" ]; then
        echo "kong bootstrap: timeout waiting for admin after ${elapsed}s; skipping"
        exit 0
      fi
      if curl -sS --max-time 2 http://127.0.0.1:8001/status >/dev/null 2>&1; then
        break
      fi
      echo "waiting for kong admin (${elapsed}s/${max_wait_seconds}s)"
      sleep 2
    done

    kong_put() {
      path="$1"
      shift
      curl -sS --max-time 5 -X PUT "http://127.0.0.1:8001${path}" \
        -H "Kong-Admin-Token: ${KONG_ADMIN_TOKEN}" \
        "$@" >/dev/null 2>&1 || return 1
      return 0
    }

    kong_post() {
      path="$1"
      shift
      curl -sS --max-time 5 -X POST "http://127.0.0.1:8001${path}" \
        -H "Kong-Admin-Token: ${KONG_ADMIN_TOKEN}" \
        "$@" >/dev/null 2>&1 || return 1
      return 0
    }

    kong_delete() {
      path="$1"
      shift || true
      curl -sS --max-time 5 -X DELETE "http://127.0.0.1:8001${path}" \
        -H "Kong-Admin-Token: ${KONG_ADMIN_TOKEN}" \
        "$@" >/dev/null 2>&1 || return 1
      return 0
    }

    # Cleanup legacy bootstrap entities from older dev flows (safe to ignore failures).
    kong_delete "/routes/api" || true
    kong_delete "/services/api" || true

    # NOTE: Services/routes are managed by the Kong Ingress Controller (KIC) via Kubernetes Ingress resources.
    # This bootstrap is only responsible for Kong Manager RBAC user setup for local dev.

    if ! kong_put "/rbac/users/${KONG_ADMIN_GUI_USER}" \
      -d name=${KONG_ADMIN_GUI_USER} \
      -d user_token=${KONG_ADMIN_TOKEN} \
      -d password=${KONG_ADMIN_GUI_PASSWORD}; then
      echo "kong bootstrap: failed to upsert admin GUI user (ignored)"
    fi

    if ! kong_post "/rbac/users/${KONG_ADMIN_GUI_USER}/roles" -d roles=admin; then
      echo "kong bootstrap: failed to assign admin role to GUI user (ignored)"
    fi

    if [ -n "${KONG_RBAC_USERS}" ]; then
      IFS=','; \
      for entry in ${KONG_RBAC_USERS}; do \
        user=$(echo "$entry" | cut -d: -f1); \
        pass=$(echo "$entry" | cut -d: -f2-); \
        if [ -n "$user" ] && [ -n "$pass" ]; then \
          if ! kong_put "/rbac/users/${user}" -d name=${user} -d user_token=${KONG_ADMIN_TOKEN} -d password=${pass}; then \
            echo "kong bootstrap: failed to upsert RBAC user ${user} (ignored)"; \
          fi; \
          if ! kong_post "/rbac/users/${user}/roles" -d roles=admin; then \
            echo "kong bootstrap: failed to assign role for ${user} (ignored)"; \
          fi; \
        fi; \
      done; \
    fi

    echo "kong bootstrap: done"
