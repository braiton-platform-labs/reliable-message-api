version: 2.1

jobs:
  build-test:
    docker:
      - image: cimg/python:3.11
        environment:
          PIP_DISABLE_PIP_VERSION_CHECK: "1"
      - image: docker:24.0.5-dind
        command: ["--host=tcp://0.0.0.0:2375", "--tls=false"]
    environment:
      DOCKER_HOST: tcp://localhost:2375
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: |
            python -m pip install --upgrade pip
            python -m pip install .[dev]
      - run:
          name: Lint
          command: ruff check .
      - run:
          name: Typecheck
          command: mypy app tests
      - run:
          name: K8s Validate
          command: make k8s-validate
      - run:
          name: Tests
          command: pytest -q
      - run:
          name: Security
          command: |
            bandit -r app
            pip-audit
      - run:
          name: Build container
          command: docker build -f docker/Dockerfile .

workflows:
  version: 2
  ci:
    jobs:
      - build-test
